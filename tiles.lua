function parse_volume(s)
    local v = {}
    for plane in all(split(s,";")) do
        local p1,p2,p3,n1,n2,n3 = unpack(split(plane,","))
        add(v, {pt = {p1,p2,p3}, normal = {n1,n2,n3}})
    end
    return v
end




empty_volumes = {}
ground_volume = {{{pt=v_zero(), normal={0,1,0}}}, v_zero()}
vols_str=[[
block_volumes=-0.5,0,0,-1,0,0;0.5,0,0,1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.5,0,0,1,0
hblock1_volumes=0,0,0,-.7071,0,-.7071;0.5,0,0,1,0,0;0,0,0.5,0,0,1;0,1,0,0,1,0
hblock2_volumes=0,0,0,.7071,0,-.7071;-0.5,0,0,-1,0,0;0,0,0.5,0,0,1;0,1,0,0,1,0
ramp_volumes=-0.5, 0, 0,-1, 0, 0;0, 0, -0.5,0, 0, -1;0, 0, 0.5,0, 0, 1;0, 0.25, 0,0.4472,0.8944,0
ramp2_volumes=-0.5, 0, 0,-1, 0, 0;0, 0, -0.5,0, 0, -1;0, 0, 0.5,0, 0, 1;0, 0.5, 0,0.7071,0.7071,0
rail1_volumes=-0.5, 0, 0,-1, 0, 0;0.5, 0, 0,1, 0, 0;0, 0, -0.1,0, 0, -1;0, 0, 0.1,0, 0, 1;0, 0.5, 0,0, 1, 0
rail2_volumes=-0.5, 0, 0,-1, 0, 0;0.5, 0, 0,1, 0, 0;0, 0, 0.4,0, 0, -1;0, 0, 0.5,0, 0, 1;0, 0.5, 0,0, 1, 0
rail3_volumes=-0.5, 0, 0.5,-.7071, 0, .7071;0.5, 0, -0.5,0.7071, 0, -0.7071;-0.1, 0, -0.1,-.7071, 0, -.7071;0.1, 0, 0.1,.7071, 0, .7071;0, 0.5, 0,0, 1, 0
rail4_volumes=-0.1, 0, 0.1,-.7071, 0, .7071;0.1, 0, -0.1,0.7071, 0, -0.7071;-0.5, 0, -0.5,-.7071, 0, -.7071;0.5, 0, 0.5,.7071, 0, .7071;0, 0.5, 0,0, 1, 0
rail5_volumes=-0.1, 0, 0.1,-.7071, 0, .7071;0.1, 0, -0.1,0.7071, 0, -0.7071;-0.5, 0, -0.5,-.7071, 0, -.7071;0.5, 0, 0.5,.7071, 0, .7071;0, 0.5, 0,0, 1, 0
qp_volumes=-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,1,0,0,1,0;0,0,0,0,-1,0;0.190,0.048,0.000,0.309,0.951,0.000/-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,1,0,0,1,0;0,0,0,0,-1,0;-0.080,0.189,0.000,0.588,0.809,0.000/-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,1,0,0,1,0;0,0,0,0,-1,0;-0.295,0.408,0.000,0.809,0.588,0.000/-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,1,0,0,1,0;0,0,0,0,-1,0;-0.433,0.684,0.000,0.951,0.309,0.000
rail6_volumes=0, 0, 0,-1, 0, 0;0.5, 0, 0,1, 0, 0;0, 0, -0.1,0, 0, -1;0, 0, 0.1,0, 0, 1;0, 0.5, 0,0, 1, 0/-0.1, 0, 0.1,-.7071, 0, .7071;0.1, 0, -0.1,0.7071, 0, -0.7071;-0.5, 0, -0.5,-.7071, 0, -.7071;0, 0, 0,.7071, 0, .7071;0, 0.5, 0,0, 1, 0
rail7_volumes=-0.5, 0, 0,-1, 0, 0;0, 0, 0,1, 0, 0;0, 0, -0.1,0, 0, -1;0, 0, 0.1,0, 0, 1;0, 0.5, 0,0, 1, 0/-0.1, 0, 0.1,-.7071, 0, .7071;0.1, 0, -0.1,0.7071, 0, -0.7071;0, 0, 0,-.7071, 0, -.7071;0.5, 0, 0.5,.7071, 0, .7071;0, 0.5, 0,0, 1, 0
stair_volumes=-0.5,0,0,-1,0,0;0.5,0,0,1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.25,0,0,1,0/-0.5,0,0,-1,0,0;0,0,0,1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.5,0,0,1,0
stairrail_volumes=-0.5,0,0,-1,0,0;0.5,0,0,1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.25,0,0,1,0/-0.5,0,0,-1,0,0;0,0,0,1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.5,0,0,1,0/-0.5, 0, 0,-1, 0, 0;0.5, 0, 0,1, 0, 0;0, 0, -0.1,0, 0, -1;0, 0, 0.1,0, 0, 1;0, 0.75, 0,0.4472,0.8944,0
barrier_volumes=0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0,0,0,-1,0;0,0.5,0,0,1,0;0.412,0.037,0.000,0.707,0.707,0.000;-0.412,0.037,0.000,-0.707,0.707,0.000/0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0,0,0,-1,0;0,0.5,0,0,1,0;0.375,0.125,0.000,1.000,0.000,0.000;-0.375,0.125,0.000,-1.000,0.000,0.000
barrier2_volumes=-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.5,0,0,1,0;0,0,0,0,-1,0;-0.235,0.066,0.000,0.500,0.866,0.000/-0.5,0,0,-1,0,0;0,0,-0.5,0,0,-1;0,0,0.5,0,0,1;0,0.5,0,0,1,0;0,0,0,0,-1,0;-0.407,0.245,0.000,0.866,0.500,0.000
fence_volumes=-0.5, 0, 0,-1, 0, 0;-0.4, 0, 0,1, 0, 0;0, 0, -0.5,0, 0, -1;0, 0, 0.5,0, 0, 1;0, 1, 0,0, 1, 0
]]

for shape in all(split(vols_str, "\n")) do
    sname, svols = unpack(split(shape,"="))
    _ENV[sname] = {}
    for vol in all(split(svols,"/")) do
        add(_ENV[sname], parse_volume(vol))
    end
end

cached_blocks = {}
for i = 0.5, 15, 0.5 do
    cached_blocks[i] = {}
    for plane in all(block_volumes[1]) do
        add(cached_blocks[i], {pt = v_copy(plane.pt), normal = v_copy(plane.normal)})
    end
    cached_blocks[i][5].pt[2] += i - 0.5
end

block2_volumes = cached_blocks[1]

--name, sprite, height, volumes, is_block, is_qp, rails
function parse_tile(s)
    local name, s1,s2, height, volumes, is_block, is_qp, rails,prefab = unpack(split(s,"/"))
    local t = {name=name,s1=s1,s2=s2,height=height,volumes=_ENV[volumes],is_block=is_block=="t",is_qp=is_qp=="t",rails={}}
    t.prefab = prefab or nil
    if #rails > 0 then
        for rail in all(split(rails,";")) do
            local p1,p2,p3,p4,p5,p6 = unpack(split(rail,","))
            add(t.rails, {{p1,p2,p3}, {p4,p5,p6}})
        end
    end
    return t
end

tiles = {}
tiles_str = [[block/2/2/0.5/block_volumes/t/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.499, 0.499,0.499, 0.499, 0.499;0.499, 0.499, 0.499,0.499, 0.499, -0.499;0.499, 0.499, -0.499,-0.499, 0.499, -0.499
ramp1/6/8/0.5/ramp_volumes/f/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.499, 0.499,0.499, 0, 0.499;0.499, 0, 0.499,0.499, 0, -0.499;0.499, 0, -0.499,-0.499, 0.499, -0.499
qp/10/12/1/qp_volumes/f/t/-0.499, 0.999, -0.499,-0.499, 0.999, 0.499
rail1/34/34/0.5/rail1_volumes/f/f/-0.499, 0.499, 0,0.499, 0.499, 0
ramp2/38/40/1/ramp2_volumes/f/f/-0.499,0.999,-0.499,-0.499,0.999,0.499;-0.499,0.999,0.499,0.499,0,0.499;0.499,0,0.499,0.499,0,-0.499;0.499,0,-0.499,-0.499,0.999,-0.499
rail2/42/42/0.5/rail2_volumes/f/f/-0.499, 0.499, 0.499,0.499, 0.499, 0.499
rail3/44/44/0.5/rail3_volumes/f/f/0.499, 0.499, -0.499,-0.499, 0.499, 0.499
rail4/46/46/0.5/rail4_volumes/f/f/0.499, 0.499, 0.499,-0.499, 0.499, -0.499
rail5/64/64/0.5/rail5_volumes/f/f/0, 0.499, -0.499,0.499, 0.499, 0
hblock1/4/4/1/hblock1_volumes/f/f/0.499, 0.999, -0.499,-0.499, 0.999, 0.499;-0.499,0.999,0.499,0.499,0.999,0.499;0.499,0.999,0.499,0.499,0.999,-0.499
hblock2/36/36/1/hblock2_volumes/f/f/0.499, 0.999, 0.499,-0.499, 0.999, -0.499;-0.499,0.999,-0.499,-0.499,0.999,0.499;-0.499,0.999,0.499,0.499,0.999,0.499
taxi1/108/108/1/block_volumes/f/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.999, 0.499,0.499, 0.499, 0.499;0.499, 0.499, 0.499,0.499, 0.499, -0.499;0.499, 0.499, -0.499,-0.499, 0.999, -0.499/t
taxi2/110/110/1/block_volumes/f/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.499, 0.499,0.499, 0.999, 0.499;0.499, 0.499, 0.499,0.499, 0.499, -0.499;0.499, 0.999, -0.499,-0.499, 0.499, -0.499/t
floor1/114/114/0/empty_volumes/f/f//t
floor2/116/116/0/empty_volumes/f/f//t
floor3/118/118/0/empty_volumes/f/f//t
floor4/98/100/0/empty_volumes/f/f//t
floor5/102/102/0/empty_volumes/f/f//t
stair/66/68/0.5/stair_volumes/f/f/
stairrail/70/72/1/stairrail_volumes/f/f/-0.499, 0.999, 0,0.499, 0.499, 0
rail6/74/76/0.5/rail6_volumes/f/f/0.499, 0.499, 0,0, 0.499, 0;0,0.499,0,-0.499,0.499,-0.499
rail7/64/78/0.5/rail7_volumes/f/f/-0.499, 0.499, 0,0, 0.499, 0;0,0.499,0,0.499,0.499,0.499
module/128/128/1/block2_volumes/t/f/-0.499, 0.999, -0.499,-0.499, 0.999, 0.499;-0.499, 0.999, 0.499,0.499, 0.999, 0.499;0.499, 0.999, 0.499,0.499, 0.999, -0.499;0.499, 0.999, -0.499,-0.499, 0.999, -0.499
barrier/132/132/0.5/barrier_volumes/f/f/0, 0.499, -0.499,0, 0.499, 0.499
fence/128/130/1/fence_volumes/f/f/-0.499, 0.999, -0.499,-0.499, 0.999, 0.499
floor6/104/104/0/empty_volumes/f/f//t
floor7/120/120/0/empty_volumes/f/f//t
door/134/136/1/empty_volumes/f/f/
barrier2/136/138/0.5/barrier2_volumes/f/t/-.5, 0.499, -0.499,-.5, 0.499, 0.499
floor8/96/96/0/empty_volumes/f/f//t
cop1/140/140/1/block_volumes/f/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.999, 0.499,0.499, 0.499, 0.499;0.499, 0.499, 0.499,0.499, 0.499, -0.499;0.499, 0.499, -0.499,-0.499, 0.999, -0.499/t
cop2/142/142/1/block_volumes/f/f/-0.499, 0.499, -0.499,-0.499, 0.499, 0.499;-0.499, 0.499, 0.499,0.499, 0.999, 0.499;0.499, 0.499, 0.499,0.499, 0.499, -0.499;0.499, 0.999, -0.499,-0.499, 0.499, -0.499/t]]

for ts in all(split(tiles_str, "\n")) do
    add(tiles, parse_tile(ts))
end